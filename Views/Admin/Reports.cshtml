@model Inventory_System.Models.ReportViewModel
@{
    ViewData["Title"] = "Admin Reports";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["ActivePage"] = "Reports"; // Add this for sidebar highlighting
}

<div class="container-fluid mt-4">

    <!-- ========================= -->
    <!-- PAGE HEADER -->
    <!-- ========================= -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">📊 Reports and Analytics</h2>
        <div>
            <!-- Removed Export to Excel button -->
            <a asp-controller="Admin" asp-action="ExportToPDF" class="btn btn-outline-danger">
                <i class="bi bi-file-earmark-pdf"></i> Export to PDF
            </a>
        </div>
    </div>

    <!-- ========================= -->
    <!-- SUMMARY CARDS - FIXED LOGIC -->
    <!-- ========================= -->
    <div class="row g-3 mb-4">
        <div class="col-md-2 col-sm-6">
            <div class="card text-center shadow-sm border-0 bg-light">
                <div class="card-body">
                    <h6>Total Equipment</h6>
                    <h4 class="fw-bold text-primary">@Model.TotalEquipment</h4>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6">
            <div class="card text-center shadow-sm border-0 bg-light">
                <div class="card-body">
                    <h6>Available</h6>
                    <h4 class="fw-bold text-success">@Model.AvailableEquipment</h4>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6">
            <div class="card text-center shadow-sm border-0 bg-light">
                <div class="card-body">
                    <h6>Borrowed</h6>
                    <h4 class="fw-bold text-warning">@Model.BorrowedEquipment</h4>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6">
            <div class="card text-center shadow-sm border-0 bg-light">
                <div class="card-body">
                    <h6>Overdue</h6>
                    <h4 class="fw-bold text-danger">@Model.OverdueEquipment</h4>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6">
            <div class="card text-center shadow-sm border-0 bg-light">
                <div class="card-body">
                    <h6>Active Users</h6>
                    <h4 class="fw-bold text-primary">@Model.ActiveUsers</h4>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6">
            <div class="card text-center shadow-sm border-0 bg-light">
                <div class="card-body">
                    <h6>Pending Accounts</h6>
                    <h4 class="fw-bold text-secondary">@Model.PendingUsers</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================= -->
    <!-- CHARTS SECTION - UPDATED -->
    <!-- ========================= -->
    <div class="row mb-4">
        <!-- Bar Chart: Equipment Quantity by Type -->
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white fw-bold">Equipment Quantity by Type</div>
                <div class="card-body">
                    <canvas id="equipmentByTypeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Bar Chart: Top 5 Most Borrowed Equipment -->
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white fw-bold">Top 5 Most Borrowed Equipment</div>
                <div class="card-body">
                    <canvas id="topBorrowedChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================= -->
    <!-- BORROWING RECORDS TABLE - REPLACED OVERDUE TABLE -->
    <!-- ========================= -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white fw-bold">
            Recent Borrowing Records
        </div>
        <div class="card-body">
            @if (Model.BorrowingRecords.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Borrow ID</th>
                                <th>Borrower</th>
                                <th>Equipment</th>
                                <th>Quantity</th>
                                <th>Borrow Date</th>
                                <th>Return Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var record in Model.BorrowingRecords)
                            {
                                <tr>
                                    <td>@record.BorrowID</td>
                                    <td>@record.Borrower</td>
                                    <td>@record.Equipment</td>
                                    <td>@record.Quantity</td>
                                    <td>@record.BorrowDate.ToString("MMM dd, yyyy")</td>
                                    <td>@(record.ReturnDate?.ToString("MMM dd, yyyy") ?? "Not Returned")</td>
                                    <td>
                                        <span class="badge @(record.Status == "Borrowed" ? "bg-warning" : record.Status == "Returned" ? "bg-success" : "bg-secondary")">
                                            @record.Status
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted">No borrowing records found.</p>
            }
        </div>
    </div>

</div>

<!-- ========================= -->
<!-- CHART.JS SCRIPTS -->
<!-- ========================= -->
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Equipment Quantity by Type (Bar Chart)
        const equipmentTypeLabels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.EquipmentByType.Keys));
        const equipmentTypeData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.EquipmentByType.Values));

        new Chart(document.getElementById('equipmentByTypeChart'), {
            type: 'bar',
            data: {
                labels: equipmentTypeLabels,
                datasets: [{
                    label: 'Total Quantity',
                    data: equipmentTypeData,
                    backgroundColor: [
                        '#007bff', '#28a745', '#ffc107', '#dc3545',
                        '#6f42c1', '#fd7e14', '#20c997'
                    ],
                    borderColor: [
                        '#0056b3', '#1e7e34', '#e0a800', '#c82333',
                        '#5a3596', '#e56107', '#199d7a'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Equipment Distribution by Type'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantity'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Equipment Type'
                        }
                    }
                }
            }
        });

        // Top Borrowed Equipment (Bar Chart)
        const topLabels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.TopBorrowedEquipment.Keys));
        const topData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.TopBorrowedEquipment.Values));

        new Chart(document.getElementById('topBorrowedChart'), {
            type: 'bar',
            data: {
                labels: topLabels,
                datasets: [{
                    label: 'Times Borrowed',
                    data: topData,
                    backgroundColor: '#007bff',
                    borderColor: '#0056b3',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Most Frequently Borrowed Equipment'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Times Borrowed'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Equipment Name'
                        }
                    }
                }
            }
        });
    </script>
}