@model IEnumerable<Inventory_System.Models.Equipment>

@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Equipment List";
    ViewData["ActivePage"] = "EquipmentList";

    // Get active borrow records from ViewBag
    var activeBorrowRecords = ViewBag.ActiveBorrowRecords as List<int> ?? new List<int>();
}

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="h3 fw-bold mb-2" style="color: var(--yale-blue);">
                    <i class="fas fa-boxes me-2"></i>Equipment Inventory Overview
                </h2>
                <p class="text-muted mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Browse and manage all equipment items in the system
                </p>
            </div>
            <a href="@Url.Action("ManageEquipment", "Admin")"
               class="btn btn-primary px-4 py-2"
               style="background: linear-gradient(135deg, var(--yale-blue) 0%, var(--medium-blue) 100%); border: none;">
                <i class="fas fa-cog me-2"></i>Manage Equipment
            </a>
        </div>
    </div>

    <!-- Status Counter Badges -->
    @{
        int availableCount = Model.Count(e => e.Quantity > 0 && e.Label == "Borrowable" && !activeBorrowRecords.Contains(e.EquipmentID));
        int borrowedCount = activeBorrowRecords.Count;
        int outOfStockCount = Model.Count(e => e.Quantity == 0);
    }

    <div class="mb-4 d-flex gap-2 flex-wrap">
        <div class="badge rounded-pill px-3 py-2"
             style="background-color: var(--success); color: white; font-size: 0.9rem;">
            <i class="fas fa-check-circle me-1"></i><span id="availableCount">@availableCount</span> Available
        </div>
        <div class="badge rounded-pill px-3 py-2"
             style="background-color: var(--warning); color: white; font-size: 0.9rem;">
            <i class="fas fa-hand-holding me-1"></i><span id="borrowedCount">@borrowedCount</span> Borrowed
        </div>
        <div class="badge rounded-pill px-3 py-2"
             style="background-color: var(--danger); color: white; font-size: 0.9rem;">
            <i class="fas fa-exclamation-triangle me-1"></i><span id="outOfStockCount">@outOfStockCount</span> Out of Stock
        </div>
        <a href="@Url.Action("EquipmentList", "Admin")"
           class="badge rounded-pill px-3 py-2 text-decoration-none"
           style="background-color: var(--powder-blue); color: var(--yale-blue); font-size: 0.9rem; transition: all 0.2s;">
            <i class="fas fa-sync-alt me-1"></i>Show All
        </a>
    </div>

    <!-- Rest of your existing Search & Filter Section remains the same -->
    <div class="card shadow-sm mb-4" style="border: 2px solid var(--powder-blue); border-radius: 12px;">
        <div class="card-body p-4">
            <form method="get" asp-action="EquipmentList">
                <div class="row g-3">
                    <!-- Search Box -->
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-semibold small" style="color: var(--yale-blue);">
                            <i class="fas fa-search me-1"></i>Search
                        </label>
                        <input type="text"
                               name="searchTerm"
                               class="form-control"
                               placeholder="Search by name or description"
                               value="@Context.Request.Query["searchTerm"]"
                               style="border: 2px solid var(--powder-blue);" />
                    </div>

                    <!-- Type Dropdown -->
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold small" style="color: var(--yale-blue);">
                            <i class="fas fa-tags me-1"></i>Type
                        </label>
                        <select name="typeFilter" class="form-select" style="border: 2px solid var(--powder-blue);">
                            <option value="">All Types</option>
                            <option value="Office Supplies" selected="@(Context.Request.Query["typeFilter"] == "Office Supplies")">Office Supplies</option>
                            <option value="Cleaning Supplies" selected="@(Context.Request.Query["typeFilter"] == "Cleaning Supplies")">Cleaning Supplies</option>
                            <option value="ICT Equipment" selected="@(Context.Request.Query["typeFilter"] == "ICT Equipment")">ICT Equipment</option>
                            <option value="Office Equipment" selected="@(Context.Request.Query["typeFilter"] == "Office Equipment")">Office Equipment</option>
                            <option value="Audio-Visual Equipment" selected="@(Context.Request.Query["typeFilter"] == "Audio-Visual Equipment")">Audio-Visual Equipment</option>
                            <option value="Sports Equipment" selected="@(Context.Request.Query["typeFilter"] == "Sports Equipment")">Sports Equipment</option>
                            <option value="Maintenance Tools" selected="@(Context.Request.Query["typeFilter"] == "Maintenance Tools")">Maintenance Tools</option>
                        </select>
                    </div>

                    <!-- Label Dropdown -->
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold small" style="color: var(--yale-blue);">
                            <i class="fas fa-bookmark me-1"></i>Label
                        </label>
                        <select name="labelFilter" class="form-select" style="border: 2px solid var(--powder-blue);">
                            <option value="">All Labels</option>
                            <option value="Borrowable" selected="@(Context.Request.Query["labelFilter"] == "Borrowable")">Borrowable</option>
                            <option value="Non-Borrowable" selected="@(Context.Request.Query["labelFilter"] == "Non-Borrowable")">Non-Borrowable</option>
                        </select>
                    </div>

                    <!-- Status Dropdown -->
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold small" style="color: var(--yale-blue);">
                            <i class="fas fa-toggle-on me-1"></i>Status
                        </label>
                        <select name="statusFilter" class="form-select" style="border: 2px solid var(--powder-blue);">
                            @{
                                var currentStatus = Context.Request.Query["statusFilter"].ToString();
                            }
                            <option value="">All Status</option>
                            <option value="Available" selected="@(currentStatus == "Available")">Available</option>
                            <option value="Borrowed" selected="@(currentStatus == "Borrowed")">Borrowed</option>
                            <option value="Out of Stock" selected="@(currentStatus == "Out of Stock")">Out of Stock</option>
                        </select>
                    </div>

                    <!-- Action Buttons -->
                    <div class="col-lg-3 col-md-12 d-flex align-items-end gap-2">
                        <button type="submit"
                                class="btn btn-primary flex-fill"
                                style="background: linear-gradient(135deg, var(--yale-blue) 0%, var(--medium-blue) 100%); border: none;">
                            <i class="fas fa-filter me-1"></i>Filter
                        </button>
                        <a href="@Url.Action("EquipmentList", "Admin")"
                           class="btn btn-outline-secondary flex-fill"
                           style="border: 2px solid var(--powder-blue); color: var(--yale-blue);">
                            <i class="fas fa-times-circle me-1"></i>Clear
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Equipment Cards Grid - 5 Cards Per Row -->
    <div class="row g-4" id="equipmentList">
        @if (Model != null && Model.Any())
        {
            foreach (var item in Model)
            {
                var isCurrentlyBorrowed = activeBorrowRecords.Contains(item.EquipmentID);

                <div class="col-xl-2dot4 col-lg-3 col-md-4 col-sm-6 equipment-card"
                     data-id="@item.EquipmentID"
                     data-name="@item.Name.ToLower()"
                     data-type="@item.Type"
                     data-label="@item.Label"
                     data-quantity="@item.Quantity"
                     data-status="@item.Status"
                     data-borrowed="@isCurrentlyBorrowed.ToString().ToLower()">

                    <div class="card h-100 shadow-sm equipment-item-card"
                         style="border: 2px solid var(--powder-blue); border-radius: 12px; transition: all 0.3s ease; overflow: hidden;">

                        <!-- Equipment Image -->
                        <div class="position-relative" style="height: 180px; overflow: hidden; background-color: var(--alice-blue);">
                            @if (!string.IsNullOrEmpty(item.ImagePath))
                            {
                                <img src="~/images/equipment/@item.ImagePath"
                                     alt="@item.Name"
                                     class="w-100 h-100"
                                     style="object-fit: cover;"
                                     onerror="this.src='/images/equipment/no-image.png'" />
                            }
                            else
                            {
                                <div class="w-100 h-100 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-box fa-4x" style="color: var(--powder-blue); opacity: 0.5;"></i>
                                </div>
                            }

                            <!-- Status Badge Overlay -->
                            <div class="position-absolute top-0 end-0 m-2">
                                @if (isCurrentlyBorrowed && item.Label == "Borrowable")
                                {
                                    <span class="badge rounded-pill px-2 py-1 status-badge" style="background-color: var(--warning); font-size: 0.7rem;">
                                        <i class="fas fa-hand-holding me-1"></i>Borrowed
                                    </span>
                                }
                                else if (item.Quantity > 0 && item.Label == "Borrowable")
                                {
                                    <span class="badge rounded-pill px-2 py-1 status-badge" style="background-color: var(--success); font-size: 0.7rem;">
                                        <i class="fas fa-check-circle me-1"></i>Available
                                    </span>
                                }
                                else if (item.Quantity == 0)
                                {
                                    <span class="badge rounded-pill px-2 py-1 status-badge" style="background-color: var(--danger); font-size: 0.7rem;">
                                        <i class="fas fa-times-circle me-1"></i>Out of Stock
                                    </span>
                                }
                                else
                                {
                                    <span class="badge rounded-pill px-2 py-1 status-badge" style="background-color: var(--secondary); font-size: 0.7rem;">
                                        <i class="fas fa-ban me-1"></i>Non-Borrowable
                                    </span>
                                }
                            </div>
                        </div>

                        <div class="card-body d-flex flex-column p-3">
                            <!-- Equipment Name -->
                            <h6 class="card-title fw-bold mb-2" style="color: var(--yale-blue); font-size: 0.95rem;">
                                @item.Name
                                @if (isCurrentlyBorrowed)
                                {
                                    <small class="text-warning ms-1"><i class="fas fa-hand-holding"></i></small>
                                }
                            </h6>

                            <!-- Description -->
                            <p class="card-text text-muted small mb-3" style="font-size: 0.8rem; line-height: 1.4;">
                                @(item.Description?.Length > 60 ? item.Description.Substring(0, 60) + "..." : item.Description)
                            </p>

                            <!-- Equipment Details -->
                            <div class="mb-3" style="font-size: 0.8rem;">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-tag me-2" style="color: var(--powder-blue); width: 16px;"></i>
                                    <span class="text-muted">Type:</span>
                                    <span class="fw-semibold ms-1" style="color: var(--yale-blue);">@item.Type</span>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-bookmark me-2" style="color: var(--powder-blue); width: 16px;"></i>
                                    <span class="text-muted">Label:</span>
                                    <span class="fw-semibold ms-1" style="color: var(--yale-blue);">@item.Label</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-boxes me-2" style="color: var(--powder-blue); width: 16px;"></i>
                                    <span class="text-muted">Quantity:</span>
                                    <span class="fw-bold ms-1 quantity-display" style="color: @(item.Quantity > 0 ? "var(--success)" : "var(--danger)");">@item.Quantity</span>
                                </div>
                                @if (isCurrentlyBorrowed)
                                {
                                    <div class="d-flex align-items-center mt-1">
                                        <i class="fas fa-clock me-2" style="color: var(--warning); width: 16px;"></i>
                                        <span class="text-muted">Status:</span>
                                        <span class="fw-semibold ms-1" style="color: var(--warning);">Currently Borrowed</span>
                                    </div>
                                }
                            </div>

                            <!-- Manage Button -->
                            <div class="mt-auto">
                                @if (item.EquipmentID > 0)
                                {
                                    <a href="@Url.Action("EditEquipment", "Admin", new { id = item.EquipmentID })"
                                       class="btn btn-sm w-100 py-2"
                                       style="background: linear-gradient(135deg, var(--yale-blue) 0%, var(--medium-blue) 100%); color: white; border: none; font-weight: 600; transition: all 0.2s;"
                                       onclick="return validateEquipmentId(@item.EquipmentID)">
                                        <i class="fas fa-edit me-1"></i>Manage
                                    </a>
                                }
                                else
                                {
                                    <button class="btn btn-sm w-100 py-2" disabled style="background-color: #ccc; color: white; border: none;">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Invalid ID
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-box-open fa-4x" style="color: var(--powder-blue); opacity: 0.5;"></i>
                    </div>
                    <h4 style="color: var(--yale-blue);">No Equipment Found</h4>
                    <p class="text-muted">No equipment items match your current filters.</p>
                    <a href="@Url.Action("EquipmentList", "Admin")" class="btn btn-outline-primary mt-3">
                        <i class="fas fa-sync-alt me-1"></i>Reset Filters
                    </a>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Live search functionality
        $(document).ready(function () {
            $('input[name="searchTerm"]').on('keyup', function () {
                var searchValue = $(this).val().toLowerCase();
                $('.equipment-card').each(function () {
                    var name = $(this).data('name');
                    $(this).toggle(name.includes(searchValue));
                });
            });

            // Real-time updates for equipment status and quantities
            function startEquipmentUpdates() {
                setInterval(updateEquipmentStatus, 5000); // Update every 5 seconds
            }

            function updateEquipmentStatus() {
                $.ajax({
                    url: '@Url.Action("GetEquipmentUpdates", "Admin")',
                    type: 'GET',
                    success: function(response) {
                        if (response.success) {
                            updateEquipmentCards(response.equipment);
                            updateStatusCounters(response.counters);
                        }
                    },
                    error: function() {
                        console.log('Error fetching equipment updates');
                    }
                });
            }

            function updateEquipmentCards(equipmentData) {
                equipmentData.forEach(function(item) {
                    var card = $('.equipment-card[data-id="' + item.equipmentID + '"]');
                    if (card.length) {
                        // Update quantity
                        var quantityDisplay = card.find('.quantity-display');
                        quantityDisplay.text(item.quantity);

                        // Update quantity color based on value
                        if (item.quantity > 0) {
                            quantityDisplay.css('color', 'var(--success)');
                        } else {
                            quantityDisplay.css('color', 'var(--danger)');
                        }

                        // Update status badge
                        var statusBadge = card.find('.status-badge');
                        updateStatusBadge(statusBadge, item.quantity, item.label, item.isBorrowed);

                        // Update borrowed indicator in card title
                        var cardTitle = card.find('.card-title');
                        if (item.isBorrowed) {
                            if (!cardTitle.find('.fa-hand-holding').length) {
                                cardTitle.append(' <small class="text-warning ms-1"><i class="fas fa-hand-holding"></i></small>');
                            }
                        } else {
                            cardTitle.find('.fa-hand-holding').parent().remove();
                        }
                    }
                });
            }

            function updateStatusBadge(statusBadge, quantity, label, isBorrowed) {
                if (isBorrowed && label === 'Borrowable') {
                    statusBadge.html('<i class="fas fa-hand-holding me-1"></i>Borrowed');
                    statusBadge.css('background-color', 'var(--warning)');
                } else if (quantity > 0 && label === 'Borrowable') {
                    statusBadge.html('<i class="fas fa-check-circle me-1"></i>Available');
                    statusBadge.css('background-color', 'var(--success)');
                } else if (quantity === 0) {
                    statusBadge.html('<i class="fas fa-times-circle me-1"></i>Out of Stock');
                    statusBadge.css('background-color', 'var(--danger)');
                } else {
                    statusBadge.html('<i class="fas fa-ban me-1"></i>Non-Borrowable');
                    statusBadge.css('background-color', 'var(--secondary)');
                }
            }

            function updateStatusCounters(counters) {
                $('#availableCount').text(counters.availableCount);
                $('#borrowedCount').text(counters.borrowedCount);
                $('#outOfStockCount').text(counters.outOfStockCount);
            }

            // Start periodic updates
            startEquipmentUpdates();

            // NEW CODE: Equipment ID validation and debugging
            function validateEquipmentId(equipmentId) {
                if (equipmentId <= 0) {
                    alert('Invalid equipment ID. Please contact administrator.');
                    return false;
                }
                return true;
            }

            // Debug: Log equipment IDs for troubleshooting
            $('.equipment-card').each(function() {
                var equipmentId = $(this).data('id');
                console.log('Equipment ID:', equipmentId, 'Valid:', equipmentId > 0);
            });
        });
    </script>
}
}